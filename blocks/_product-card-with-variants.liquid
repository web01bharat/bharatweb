{%- comment -%}
  Enhanced Product Card with Variants for Resource List Carousel
  This block renders product cards with variant swatches and interactions
{%- endcomment -%}

{%- liquid
  assign product = closest.product
  
  unless product
    assign product = block.settings.product
  endunless
  
  if product == blank
    assign onboarding = true
  endif
-%}

<div class="product-card product-card--with-variants" data-product-id="{{ product.id }}" data-product-handle="{{ product.handle }}">
  <div class="product-card__inner">
    {%- unless onboarding -%}
      
      {%- comment -%} Product Image {%- endcomment -%}
      <div class="product-card__media">
        {%- if product.featured_media -%}
          <a href="{{ product.url }}" class="product-card__media-link">
            <img
              src="{{ product.featured_media | image_url: width: 400 }}"
              alt="{{ product.featured_media.alt | escape }}"
              loading="lazy"
              width="400"
              height="{{ 400 | divided_by: product.featured_media.aspect_ratio | round }}"
              class="product-card__media-img"
            >
          </a>
        {%- endif -%}
      </div>

      {%- comment -%} Product Info {%- endcomment -%}
      <div class="product-card__content">
        <h3 class="product-card__title">
          <a href="{{ product.url }}">{{ product.title }}</a>
        </h3>
        
        <div class="product-card__price">
          {%- if product.price_varies -%}
            <span class="price">
              From {{ product.price_min | money }}
            </span>
          {%- elsif product.compare_at_price > product.price -%}
            <span class="price price--on-sale">
              <span class="price__current">{{ product.price | money }}</span>
              <span class="price__compare">{{ product.compare_at_price | money }}</span>
            </span>
          {%- else -%}
            <span class="price">{{ product.price | money }}</span>
          {%- endif -%}
        </div>

        {%- comment -%} Product Variants Display {%- endcomment -%}
        {%- if product.variants.size > 1 -%}
          <div class="product-card__variants" data-product-id="{{ product.id }}">
            
            {%- comment -%} Size Options {%- endcomment -%}
            {%- assign size_option = product.options_with_values | where: 'name', 'Size' | first -%}
            {%- if size_option and size_option.values.size > 1 -%}
              <div class="variant-swatches variant-swatches--size">
                <span class="variant-label">Size:</span>
                <div class="swatches">
                  {%- for value in size_option.values limit: 5 -%}
                    {%- assign variant_available = false -%}
                    {%- assign matching_variant = null -%}
                    {%- for variant in product.variants -%}
                      {%- if variant.option1 == value or variant.option2 == value or variant.option3 == value -%}
                        {%- assign matching_variant = variant -%}
                        {%- if variant.available -%}
                          {%- assign variant_available = true -%}
                          {%- break -%}
                        {%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}
                    
                    <button 
                      type="button" 
                      class="swatch swatch--size{% unless variant_available %} swatch--unavailable{% endunless %}"
                      data-option-name="Size"
                      data-option-value="{{ value | escape }}"
                      data-variant-id="{% if matching_variant %}{{ matching_variant.id }}{% endif %}"
                      data-product-id="{{ product.id }}"
                      {% unless variant_available %}disabled{% endunless %}
                      aria-label="Size: {{ value }}"
                    >
                      {{ value }}
                    </button>
                  {%- endfor -%}
                </div>
              </div>
            {%- endif -%}

            {%- comment -%} Color Options {%- endcomment -%}
            {%- assign color_option = product.options_with_values | where: 'name', 'Color' | first -%}
            {%- if color_option and color_option.values.size > 1 -%}
              <div class="variant-swatches variant-swatches--color">
                <span class="variant-label">Color:</span>
                <div class="swatches">
                  {%- for value in color_option.values limit: 4 -%}
                    {%- assign variant_available = false -%}
                    {%- assign variant_image = null -%}
                    {%- assign matching_variant = null -%}
                    {%- for variant in product.variants -%}
                      {%- if variant.option1 == value or variant.option2 == value or variant.option3 == value -%}
                        {%- assign matching_variant = variant -%}
                        {%- if variant.available -%}
                          {%- assign variant_available = true -%}
                        {%- endif -%}
                        {%- if variant.featured_media -%}
                          {%- assign variant_image = variant.featured_media -%}
                        {%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}
                    
                    <button 
                      type="button" 
                      class="swatch swatch--color{% unless variant_available %} swatch--unavailable{% endunless %}"
                      data-option-name="Color"
                      data-option-value="{{ value | escape }}"
                      data-variant-id="{% if matching_variant %}{{ matching_variant.id }}{% endif %}"
                      data-product-id="{{ product.id }}"
                      {% if variant_image %}data-variant-image="{{ variant_image | image_url: width: 400 }}"{% endif %}
                      {% unless variant_available %}disabled{% endunless %}
                      title="{{ value }}"
                      aria-label="Color: {{ value }}"
                    >
                      {%- if variant_image -%}
                        <img 
                          src="{{ variant_image | image_url: width: 30 }}" 
                          alt="{{ value }}" 
                          loading="lazy"
                          width="30"
                          height="30"
                        >
                      {%- else -%}
                        <span class="swatch-color" style="background-color: {{ value | downcase | replace: ' ', '' }}"></span>
                      {%- endif -%}
                    </button>
                  {%- endfor -%}
                </div>
              </div>
            {%- endif -%}

            {%- comment -%} Style/Material Options {%- endcomment -%}
            {%- assign style_option = product.options_with_values | where: 'name', 'Style' | first -%}
            {%- unless style_option -%}
              {%- assign style_option = product.options_with_values | where: 'name', 'Material' | first -%}
            {%- endunless -%}
            {%- if style_option and style_option.values.size > 1 -%}
              <div class="variant-swatches variant-swatches--style">
                <span class="variant-label">{{ style_option.name }}:</span>
                <div class="swatches">
                  {%- for value in style_option.values limit: 3 -%}
                    {%- assign variant_available = false -%}
                    {%- assign matching_variant = null -%}
                    {%- for variant in product.variants -%}
                      {%- if variant.option1 == value or variant.option2 == value or variant.option3 == value -%}
                        {%- assign matching_variant = variant -%}
                        {%- if variant.available -%}
                          {%- assign variant_available = true -%}
                          {%- break -%}
                        {%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}
                    
                    <button 
                      type="button" 
                      class="swatch swatch--style{% unless variant_available %} swatch--unavailable{% endunless %}"
                      data-option-name="{{ style_option.name }}"
                      data-option-value="{{ value | escape }}"
                      data-variant-id="{% if matching_variant %}{{ matching_variant.id }}{% endif %}"
                      data-product-id="{{ product.id }}"
                      {% unless variant_available %}disabled{% endunless %}
                      aria-label="{{ style_option.name }}: {{ value }}"
                    >
                      {{ value | truncate: 10 }}
                    </button>
                  {%- endfor -%}
                </div>
              </div>
            {%- endif -%}

            {%- comment -%} Show variant count if no specific options shown {%- endcomment -%}
            {%- unless size_option or color_option or style_option -%}
              <div class="variant-swatches variant-swatches--generic">
                <span class="variant-info">{{ product.variants.size }} variants available</span>
              </div>
            {%- endunless -%}
          </div>
        {%- endif -%}

        {%- comment -%} Quick Add Button {%- endcomment -%}
        <div class="product-card__actions">
          {%- if product.variants.size == 1 and product.first_available_variant.available -%}
            <button
              type="button" 
              class="button button--primary button--small quick-add-btn"
              data-variant-id="{{ product.first_available_variant.id }}"
              data-product-id="{{ product.id }}"
            >
              Quick Add - {{ product.first_available_variant.price | money }}
            </button>
          {%- elsif product.available -%}
            <a href="{{ product.url }}" class="button button--secondary button--small">
              Select Options
            </a>
          {%- else -%}
            <button type="button" class="button button--disabled button--small" disabled>
              Sold Out
            </button>
          {%- endif -%}
        </div>
      </div>
      
    {%- else -%}
      {%- comment -%} Onboarding placeholder {%- endcomment -%}
      <div class="product-card__placeholder">
        <div class="product-card__media placeholder">
          <svg width="100%" height="200" viewBox="0 0 200 200" fill="none">
            <rect width="200" height="200" fill="#f3f4f6"/>
            <text x="50%" y="50%" text-anchor="middle" dy="0.3em" fill="#9ca3af" font-size="14">
              Product Image
            </text>
          </svg>
        </div>
        <div class="product-card__content">
          <h3 class="product-card__title">Product Title</h3>
          <div class="product-card__price">$0.00</div>
          <div class="product-card__variants">
            <div class="variant-swatches variant-swatches--size">
              <span class="variant-label">Size:</span>
              <div class="swatches">
                <button class="swatch swatch--size">S</button>
                <button class="swatch swatch--size">M</button>
                <button class="swatch swatch--size">L</button>
              </div>
            </div>
          </div>
          <div class="product-card__actions">
            <button class="button button--primary button--small">Quick Add</button>
          </div>
        </div>
      </div>
    {%- endunless -%}
  </div>
</div>

{%- comment -%} Add styles for the variant swatches {%- endcomment -%}
<style>
  .product-card--with-variants {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .product-card__inner {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  
  .product-card__content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 12px;
  }
  
  .product-card__variants {
    margin: 8px 0;
    flex-grow: 1;
  }
  
  .variant-swatches {
    margin-bottom: 8px;
  }
  
  .variant-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 4px;
    color: rgb(var(--color-foreground));
  }
  
  .swatches {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  
  .swatch {
    border: 1px solid rgba(var(--color-foreground), 0.2);
    background: transparent;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    font-size: 0.65rem;
  }
  
  .swatch--size,
  .swatch--style {
    padding: 4px 8px;
    min-width: 28px;
    text-align: center;
  }
  
  .swatch--color {
    width: 24px;
    height: 24px;
    padding: 2px;
    overflow: hidden;
  }
  
  .swatch--color img,
  .swatch-color {
    width: 100%;
    height: 100%;
    border-radius: 2px;
    object-fit: cover;
  }
  
  .swatch:hover:not(:disabled) {
    border-color: rgb(var(--color-foreground));
    transform: scale(1.05);
  }
  
  .swatch--selected {
    border-color: rgb(var(--color-foreground)) !important;
    border-width: 2px;
  }
  
  .swatch--selected::after {
    content: 'âœ“';
    position: absolute;
    top: -2px;
    right: -2px;
    background: rgb(var(--color-foreground));
    color: rgb(var(--color-background));
    border-radius: 50%;
    width: 12px;
    height: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: bold;
  }
  
  .swatch--unavailable {
    opacity: 0.4;
    cursor: not-allowed;
  }
  
  .swatch--unavailable::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 10%;
    right: 10%;
    height: 1px;
    background: rgb(var(--color-foreground));
    transform: translateY(-50%) rotate(45deg);
    z-index: 1;
  }
  
  .product-card__actions {
    margin-top: auto;
    padding-top: 8px;
  }
  
  .quick-add-btn,
  .product-card__actions .button {
    width: 100%;
    text-align: center;
  }
  
  .variant-info {
    font-size: 0.75rem;
    color: rgb(var(--color-foreground-rgb) / 0.7);
  }
  
  /* Responsive adjustments */
  @media (max-width: 749px) {
    .variant-label {
      font-size: 0.7rem;
    }
    
    .swatch--size,
    .swatch--style {
      padding: 3px 6px;
      min-width: 24px;
      font-size: 0.6rem;
    }
    
    .swatch--color {
      width: 20px;
      height: 20px;
    }
  }
</style>

{% schema %}
{
  "name": "Product Card Variants",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "info": "Select a product to display (fallback if no product context)"
    },
    {
      "type": "checkbox",
      "id": "show_variants",
      "label": "Show product variants",
      "default": true,
      "info": "Display size, color, and style variant swatches"
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "label": "Show quick add button",
      "default": true,
      "info": "Display add to cart button on product cards"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image aspect ratio",
      "default": "adapt",
      "options": [
        {
          "value": "adapt",
          "label": "Adapt to image"
        },
        {
          "value": "portrait",
          "label": "Portrait"
        },
        {
          "value": "square",
          "label": "Square"
        }
      ]
    }
  ]
}
{% endschema %}
